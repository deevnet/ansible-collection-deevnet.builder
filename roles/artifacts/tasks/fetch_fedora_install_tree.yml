---
# Mirror Fedora install tree using rsync
# Required fields: name, rsync_url, dest_subdir
#
# Example inventory entry:
#   - name: "Fedora 43 Server Install Tree"
#     type: fedora_install_tree
#     rsync_url: "rsync://dl.fedoraproject.org/fedora-enchilada/linux/releases/43/Server/x86_64/os/"
#     dest_subdir: "fedora/43/mirror"

- name: Ensure rsync is installed
  ansible.builtin.dnf:
    name: rsync
    state: present
  become: true

- name: Ensure install tree destination exists
  ansible.builtin.file:
    path: "{{ nginx_artifacts_root }}/{{ artifact_item.dest_subdir }}"
    state: directory
    mode: "0755"
  become: true

- name: Ensure artifacts log directory exists
  ansible.builtin.file:
    path: "{{ nginx_artifacts_root }}/logs/rsync"
    state: directory
    mode: "0755"
  become: true

# Build a candidate list of rsync sources for this artifact.
# Supports:
#   - rsync_url: "rsync://host/path/"
#   - rsync_urls: ["rsync://host/path/", ...]
#   - rsync_mirrors: ["rsync://host/base", ...] + rsync_path: "path/from/base/"
- name: Build rsync candidate list for {{ artifact_item.name }}
  ansible.builtin.set_fact:
    rsync_candidates: >-
      {{
        (
          artifact_item.rsync_urls
          | default([])
        )
        +
        (
          ([artifact_item.rsync_url] if (artifact_item.rsync_url is defined) else [])
        )
        +
        (
          (
            artifact_item.rsync_mirrors
            | default([])
            | map('regex_replace', '/$', '')
            | map('regex_replace', '$', '/' ~ (artifact_item.rsync_path | default('')))
            | list
          )
          if (artifact_item.rsync_mirrors is defined)
          else []
        )
      }}

- name: Assert rsync candidates exist for {{ artifact_item.name }}
  ansible.builtin.assert:
    that:
      - rsync_candidates | length > 0
    fail_msg: >
      No rsync sources defined for {{ artifact_item.name }}.
      Provide rsync_url, rsync_urls, or rsync_mirrors+rsync_path.
  become: false

# Try each candidate in order until one succeeds (rc 0 or 1).
- name: Mirror install tree via rsync (with fallbacks) for {{ artifact_item.name }}
  ansible.builtin.shell: |
    set -euo pipefail

    # One log per artifact, safe filename
    safe_name="{{ artifact_item.name | lower | regex_replace('[^a-z0-9._-]+', '_') }}"
    log_dir="{{ nginx_artifacts_root }}/logs/rsync"
    log="${log_dir}/${safe_name}.log"
    chg="${log_dir}/${safe_name}.changes"

    mkdir -p "$log_dir"
    : > "$chg"

    src="{{ item }}"
    dest="{{ nginx_artifacts_root }}/{{ artifact_item.dest_subdir }}/"

    echo "RSYNC_SOURCE=${src}" | tee "$log" >/dev/null

    rsync -aH --numeric-ids --delete --partial --inplace \
      --contimeout=30 --timeout=180 \
      --itemize-changes \
      "${src}" \
      "${dest}" \
      | tee -a "$log" \
      | awk '/^[<>ch\.]/ {print}' > "$chg"

    # rc=0 means changes (chg file non-empty), rc=1 means no changes
    test -s "$chg"
  args:
    executable: /bin/bash
  register: rsync_result
  loop: "{{ rsync_candidates }}"
  loop_control:
    label: "{{ item }}"
  become: true

  # Important:
  # - We do NOT fail the task just because a mirror fails; we want to try the next one.
  # - We'll declare success if ANY candidate returns rc 0 or 1.
  failed_when: false
  changed_when: false

- name: Fail if all rsync mirrors failed for {{ artifact_item.name }}
  ansible.builtin.fail:
    msg: >
      All rsync sources failed for {{ artifact_item.name }}.
      Candidates tried: {{ rsync_candidates }}
      Last rc: {{ (rsync_result.results | last).rc if (rsync_result.results | length > 0) else 'n/a' }}
      Last stderr: {{ (rsync_result.results | last).stderr if (rsync_result.results | length > 0) else 'n/a' }}
  when: >
    (rsync_result.results | selectattr('rc', 'in', [0,1]) | list | length) == 0

- name: Mark rsync changed/no-change for {{ artifact_item.name }}
  ansible.builtin.set_fact:
    rsync_effective_rc: >-
      {{
        (
          rsync_result.results
          | selectattr('rc', 'in', [0,1])
          | map(attribute='rc')
          | list
          | first
        )
      }}
  when: >
    (rsync_result.results | selectattr('rc', 'in', [0,1]) | list | length) > 0

- name: Set task changed status for {{ artifact_item.name }}
  ansible.builtin.debug:
    msg: >-
      rsync succeeded (rc={{ rsync_effective_rc }}) for {{ artifact_item.name }}
  changed_when: rsync_effective_rc == 0
  when: rsync_effective_rc is defined

