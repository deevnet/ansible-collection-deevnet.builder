# Proxmox ISO download with GPG + checksum validation
#
# Proxmox uses separate SHA256SUMS and SHA256SUMS.asc files
# (unlike Fedora which has an embedded signature in the checksum file)

- name: Check if Proxmox ISO already published to artifacts
  ansible.builtin.stat:
    path: "{{ nginx_artifacts_root }}/{{ artifact_item.dest_subdir }}/{{ artifact_item.dest_filename }}"
  register: proxmox_artifact_stat
  become: true

- name: Debug - show stat result for Proxmox ISO
  ansible.builtin.debug:
    msg: "File exists: {{ proxmox_artifact_stat.stat.exists | default('UNDEFINED') }} at {{ nginx_artifacts_root }}/{{ artifact_item.dest_subdir }}/{{ artifact_item.dest_filename }}"

- name: Download, verify, and publish Proxmox ISO (only if missing)
  when: not proxmox_artifact_stat.stat.exists
  block:

    - name: Ensure temp directory exists
      ansible.builtin.file:
        path: "/tmp/proxmox_iso_{{ artifact_item.name }}"
        state: directory
        mode: "0700"
      become: true

    - name: Download Proxmox GPG key
      ansible.builtin.get_url:
        url: "{{ artifact_item.gpg_key_url }}"
        dest: "/tmp/proxmox_iso_{{ artifact_item.name }}/proxmox-release.gpg"
        mode: "0644"
      become: true

    - name: Create temporary GPG home directory
      ansible.builtin.file:
        path: "/tmp/proxmox_iso_{{ artifact_item.name }}/gnupg"
        state: directory
        mode: "0700"
      become: true

    - name: Import Proxmox GPG key into temporary keyring
      ansible.builtin.command:
        cmd: >
          gpg --homedir /tmp/proxmox_iso_{{ artifact_item.name }}/gnupg
          --import /tmp/proxmox_iso_{{ artifact_item.name }}/proxmox-release.gpg
      register: gpg_import
      changed_when: "'imported' in gpg_import.stderr"
      become: true

    - name: Download SHA256SUMS checksum file
      ansible.builtin.get_url:
        url: "{{ artifact_item.checksum_url }}"
        dest: "/tmp/proxmox_iso_{{ artifact_item.name }}/SHA256SUMS"
        mode: "0644"
      become: true

    - name: Download SHA256SUMS.asc signature file
      ansible.builtin.get_url:
        url: "{{ artifact_item.signature_url }}"
        dest: "/tmp/proxmox_iso_{{ artifact_item.name }}/SHA256SUMS.asc"
        mode: "0644"
      become: true

    - name: Verify checksum signature (detached signature)
      ansible.builtin.command:
        cmd: >
          gpg --homedir /tmp/proxmox_iso_{{ artifact_item.name }}/gnupg
          --verify
          /tmp/proxmox_iso_{{ artifact_item.name }}/SHA256SUMS.asc
          /tmp/proxmox_iso_{{ artifact_item.name }}/SHA256SUMS
      register: gpg_verify
      changed_when: false
      failed_when: gpg_verify.rc != 0
      become: true

    - name: Download Proxmox ISO
      ansible.builtin.get_url:
        url: "{{ artifact_item.iso_url }}"
        dest: "/tmp/proxmox_iso_{{ artifact_item.name }}/{{ artifact_item.dest_filename }}"
        mode: "0644"
        timeout: 1800  # 30 minutes - Proxmox ISOs are ~2GB
      become: true

    - name: Verify ISO checksum
      ansible.builtin.command:
        cmd: >
          sha256sum --ignore-missing -c /tmp/proxmox_iso_{{ artifact_item.name }}/SHA256SUMS
      args:
        chdir: "/tmp/proxmox_iso_{{ artifact_item.name }}"
      register: checksum_verify
      changed_when: false
      failed_when: checksum_verify.rc != 0
      become: true

    - name: Ensure destination directory exists
      ansible.builtin.file:
        path: "{{ nginx_artifacts_root }}/{{ artifact_item.dest_subdir }}"
        state: directory
        mode: "0755"
      become: true

    - name: Publish ISO to artifacts directory
      ansible.builtin.copy:
        src: "/tmp/proxmox_iso_{{ artifact_item.name }}/{{ artifact_item.dest_filename }}"
        dest: "{{ nginx_artifacts_root }}/{{ artifact_item.dest_subdir }}/{{ artifact_item.dest_filename }}"
        remote_src: true
        mode: "0644"
      become: true

    - name: Verify ISO was published successfully
      ansible.builtin.stat:
        path: "{{ nginx_artifacts_root }}/{{ artifact_item.dest_subdir }}/{{ artifact_item.dest_filename }}"
      register: published_stat
      become: true

    - name: Debug - confirm publish succeeded
      ansible.builtin.debug:
        msg: "ISO published: {{ published_stat.stat.exists }}, size: {{ published_stat.stat.size | default('N/A') }} bytes"

    - name: Remove temporary Proxmox download directory
      ansible.builtin.file:
        path: "/tmp/proxmox_iso_{{ artifact_item.name }}"
        state: absent
      become: true
