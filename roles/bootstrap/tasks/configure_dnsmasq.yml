---
# roles/bootstrap/tasks/configure_dnsmasq.yml

- name: Deploy dnsmasq configuration
  ansible.builtin.template:
    src: dnsmasq.conf.j2
    dest: "{{ bootstrap_dnsmasq_conf_path }}"
    owner: root
    group: root
    mode: "0644"
    validate: 'dnsmasq --test --conf-file=%s'
  notify: restart dnsmasq
  become: true

- name: Enable and start dnsmasq service
  block:
    - name: Start dnsmasq service
      ansible.builtin.service:
        name: dnsmasq
        enabled: true
        state: started
  rescue:
    - name: Capture dnsmasq failure details
      ansible.builtin.command:
        cmd: journalctl -u dnsmasq -n 50 --no-pager
      register: dnsmasq_journal
      changed_when: false

    - name: Display failure details
      ansible.builtin.fail:
        msg: |
          dnsmasq failed to start:
          {{ dnsmasq_journal.stdout | default('No output') }}
  become: true
  when: bootstrap_dnsmasq_service_enabled | bool

- name: Ensure dnsmasq is stopped and disabled (safe mode)
  ansible.builtin.service:
    name: dnsmasq
    enabled: false
    state: stopped
  become: true
  when: not (bootstrap_dnsmasq_service_enabled | bool)
