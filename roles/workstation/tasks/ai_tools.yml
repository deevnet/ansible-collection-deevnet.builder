# roles/deevnet.builder.workstation/tasks/ai_tools.yml

- name: Install Node.js
  ansible.builtin.package:
    name: nodejs
    state: present
  become: true

# Migration: Remove old npm-based Claude Code installation
- name: Uninstall npm-based Claude CLI for dev users (migration)
  become: true
  become_user: "{{ item.name }}"
  loop: "{{ dev_users }}"
  environment:
    NPM_CONFIG_PREFIX: "{{ item.home }}/.npm-global"
  ansible.builtin.command:
    cmd: npm uninstall -g @anthropic-ai/claude-code
  register: npm_uninstall
  failed_when: false
  changed_when: npm_uninstall.rc == 0

# Install Claude Code via native installer (auto-updates in background)
- name: Install Claude CLI via native installer for dev users
  become: true
  become_user: "{{ item.name }}"
  loop: "{{ dev_users }}"
  ansible.builtin.shell: |
    curl -fsSL https://claude.ai/install.sh | bash
  args:
    creates: "{{ item.home }}/.local/bin/claude"
  async: 600
  poll: 30

- name: Install Gemini CLI for dev users
  become: true
  become_user: "{{ item.name }}"
  loop: "{{ dev_users }}"
  environment:
    NPM_CONFIG_PREFIX: "{{ item.home }}/.npm-global"
  npm:
    name: "@google/gemini-cli"
    global: yes
    state: present
  async: 600
  poll: 30

- name: Install OpenAI Codex CLI dev users
  become: true
  become_user: "{{ item.name }}"
  loop: "{{ dev_users }}"
  environment:
    NPM_CONFIG_PREFIX: "{{ item.home }}/.npm-global"
  npm:
    name: "@openai/codex"
    global: yes
    state: present
  async: 600
  poll: 30
