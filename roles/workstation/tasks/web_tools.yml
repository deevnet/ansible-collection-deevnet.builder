---
# Web/documentation tools - Hugo static site generator

- name: Check if Hugo is installed
  ansible.builtin.command:
    cmd: hugo version
  register: hugo_version_check
  changed_when: false
  failed_when: false

- name: Check Hugo version matches desired
  ansible.builtin.set_fact:
    hugo_needs_install: >-
      {{ hugo_version_check.rc != 0 or
         ('v' + hugo_version) not in hugo_version_check.stdout }}

- name: Create temporary directory for Hugo download
  ansible.builtin.tempfile:
    state: directory
    prefix: hugo_
  register: hugo_temp_dir
  when: hugo_needs_install

- name: Download Hugo extended tarball
  ansible.builtin.get_url:
    url: "{{ hugo_tarball_url }}"
    dest: "{{ hugo_temp_dir.path }}/hugo.tar.gz"
    checksum: "sha256:{{ hugo_tarball_sha256 }}"
    mode: "0644"
  when: hugo_needs_install

- name: Extract Hugo binary
  ansible.builtin.unarchive:
    src: "{{ hugo_temp_dir.path }}/hugo.tar.gz"
    dest: "{{ hugo_temp_dir.path }}"
    remote_src: true
  when: hugo_needs_install

- name: Install Hugo to /usr/local/bin
  become: true
  ansible.builtin.copy:
    src: "{{ hugo_temp_dir.path }}/hugo"
    dest: /usr/local/bin/hugo
    mode: "0755"
    remote_src: true
  when: hugo_needs_install

- name: Clean up Hugo temp directory
  ansible.builtin.file:
    path: "{{ hugo_temp_dir.path }}"
    state: absent
  when: hugo_needs_install and hugo_temp_dir.path is defined
