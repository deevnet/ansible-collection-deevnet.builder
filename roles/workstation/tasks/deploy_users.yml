# --- Dev users setup ---

- name: Debug dev_users (inside role)
  ansible.builtin.debug:
    var: dev_users
  when: dev_users_debug | default(false)

- name: Ensure devusers group exists
  ansible.builtin.group:
    name: devusers
    state: present

- name: Ensure /srv/dvnt exists with shared permissions
  file:
    path: /srv/dvnt
    state: directory
    owner: a_autoprov
    group: devusers
    mode: "2775"

- name: Set default ACLs for /srv/dvnt
  acl:
    path: /srv/dvnt
    default: yes
    etype: group
    entity: devusers
    permissions: rwx
    state: present

- name: Ensure devusers have rwx ACL on /srv/dvnt
  acl:
    path: /srv/dvnt
    etype: group
    entity: devusers
    permissions: rwx
    state: present

- name: Ensure primary groups for dev users exist
  ansible.builtin.group:
    name: "{{ user.primary_group | default(user.name) }}"
    state: present
  loop: "{{ dev_users | default([]) }}"
  loop_control:
    loop_var: user
  become: true

- name: Ensure dev users exist
  ansible.builtin.user:
    name: "{{ user.name }}"
    group: "{{ user.primary_group | default(user.name) }}"
    groups: "{{ (user.extra_groups | default([])) + ['devusers'] }}"
    append: true
    shell: "{{ user.shell | default('/bin/bash') }}"
    create_home: true
    state: present
  loop: "{{ dev_users | default([]) }}"
  loop_control:
    loop_var: user
  become: true

- name: Ensure .ssh directory exists for dev users
  ansible.builtin.file:
    path: "{{ user.home | default('/home/' + user.name) }}/.ssh"
    state: directory
    owner: "{{ user.name }}"
    group: "{{ user.primary_group | default(user.name) }}"
    mode: "0700"
  loop: "{{ dev_users | default([]) }}"
  loop_control:
    loop_var: user
  become: true

- name: Install authorized_keys for dev users from URL (GitHub or other)
  ansible.builtin.get_url:
    url: "{{ user.github_keys_url }}"
    dest: "{{ user.home | default('/home/' + user.name) }}/.ssh/authorized_keys"
    owner: "{{ user.name }}"
    group: "{{ user.primary_group | default(user.name) }}"
    mode: "0600"
  when: user.github_keys_url is defined
  loop: "{{ dev_users | default([]) }}"
  loop_control:
    loop_var: user
  become: true

- name: Ensure DEEVNET X11 auto-DISPLAY block in .bashrc
  ansible.builtin.blockinfile:
    path: "{{ item.home | default('/home/' + item.name) }}/.bashrc"
    create: true
    owner: "{{ item.name }}"
    group: "{{ item.primary_group | default(item.name) }}"
    mode: "0644"
    marker: "# {mark} DEEVNET X11 DISPLAY BLOCK"
    block: |
      # --- DEEVNET X11 AUTO-DISPLAY ---
      # Set DISPLAY only if:
      #  1. DISPLAY is not already set (i.e. not ssh -X)
      #  2. This is an SSH session (SSH_CLIENT present)
      #  3. The SSH client is assumed to run an X server (e.g. Mac XQuartz)
      if [ -z "$DISPLAY" ] && [ -n "$SSH_CLIENT" ]; then
        # SSH_CLIENT="client_ip client_port server_port"
        export DISPLAY="$(echo "$SSH_CLIENT" | awk '{print $1}'):0"
      fi
      # --- END DEEVNET X11 AUTO-DISPLAY ---
  loop: "{{ dev_users | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  become: true

- name: Ensure per-user npm-global directory exists
  ansible.builtin.file:
    path: "{{ item.home | default('/home/' + item.name) }}/.npm-global"
    state: directory
    mode: "0755"
  loop: "{{ dev_users | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  become: true
  become_user: "{{ item.name }}"

- name: Ensure per-user .npmrc sets prefix to ~/.npm-global
  ansible.builtin.lineinfile:
    path: "{{ item.home | default('/home/' + item.name) }}/.npmrc"
    regexp: "^prefix="
    line: "prefix={{ item.home | default('/home/' + item.name) }}/.npm-global"
    create: true
  loop: "{{ dev_users | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  become: true
  become_user: "{{ item.name }}"

- name: Ensure npm-global/bin is on PATH in dev users' bashrc
  ansible.builtin.lineinfile:
    path: "{{ item.home | default('/home/' + item.name) }}/.bashrc"
    regexp: "npm-global/bin"
    line: 'export PATH="$HOME/.npm-global/bin:$PATH"'
    insertafter: EOF
    create: true
  loop: "{{ dev_users | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  become: true
  become_user: "{{ item.name }}"

# --- TEMPORARY: dev users full sudo for image-building unblock (remove later) ---
- name: TEMPORARY - allow devusers full passwordless sudo
  ansible.builtin.copy:
    dest: /etc/sudoers.d/90-dev-users
    owner: root
    group: root
    mode: "0440"
    content: |
      # TEMPORARY: allow dev users full sudo for image-building unblock.
      # TODO: replace with least-privilege (builders group + constrained command).
      %devusers ALL=(ALL) NOPASSWD:ALL
  become: true

- name: Validate sudoers drop-in
  ansible.builtin.command: visudo -cf /etc/sudoers.d/90-dev-users
  changed_when: false
  become: true
